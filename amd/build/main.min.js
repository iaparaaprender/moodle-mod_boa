/**
 * JS to connect with BoA repositories.
 *
 * @module     mod_boa/main
 * @copyright  2024 David Herney @ BambuCo
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_boa/main",["jquery","core/modal_factory","core/modal_events","core/templates","core/log","core/ajax","mod_boa/util"],(function($,ModalFactory,ModalEvents,Templates,Log,Ajax,BoAUtil){var $errorBox=null,global={selected:[]},strings=[{key:"noresultsfound",component:"mod_boa"},{key:"removeselected",component:"mod_boa"},{key:"saved",component:"mod_boa"},{key:"notsaved",component:"mod_boa"}],s=[];$.boasearch=function(el,params){var $boasearchBox,$boasearch=$(el),$boasearchSuggestions=$('<ul class="boasearch-suggestions"></ul>'),cacheResults=[],requestObjects=[],startRecord=0;$boasearch.wrap('<span class="boasearch-box"></span>'),($boasearchBox=$boasearch.parent()).append($boasearchSuggestions),$boasearchSuggestions.customReset=function(){$boasearchSuggestions.empty(),$boasearchSuggestions.hide(),$boasearchSuggestions.data("off",!0)},$boasearchSuggestions.customReset(),params.options&&(params.options=$.extend({},$.boasearch.defaults.options,params.options)),params.events&&(params.events=$.extend({},$.boasearch.defaults.events,params.events)),params.results&&(params.results=$.extend({},$.boasearch.defaults.results,params.results)),$boasearch.conf=$.extend({},$.boasearch.defaults,params),$boasearch.attr("autocomplete","off");$.data(el,"boasearch",$boasearch);var methods={init:function(){if(!$boasearch.conf.apiuri)return txt="Configuration error: You need set the API URI.",void("dev"===level?$boasearch.conf.debug&&Log.debug("BoASearch - "+txt):Log.debug("BoASearch - "+txt));var txt,level;$boasearch.on("keypress",(function(event){if(event.keyCode)switch(event.keyCode){case 13:event.preventDefault(),$boasearchSuggestions.customReset();break;case 27:$boasearchSuggestions.customReset();break;case 38:$boasearchSuggestions.data("off")||methods.previousItemMarkup();break;case 40:$boasearchSuggestions.data("off")||methods.nextItemMarkup()}})),$boasearch.on("keyup",(function(event){var val=$boasearch.val(),specialKeys=[13,16,17,18,27,33,34,35,36,37,38,39,45,144];$boasearchSuggestions.data("off")||(specialKeys[specialKeys.length]=40),event.keyCode&&-1==specialKeys.indexOf(event.keyCode)?val.length>=$boasearch.conf.options.minLetters?$boasearch.printSuggestions(val):$boasearchSuggestions.customReset():13===event.keyCode&&$boasearch.search()})),$boasearchBox.on("focusout",(function(){window.setTimeout((function(){$boasearchSuggestions.customReset()}),100)}))},getItemMarkup:function(item,query){var text=""!=item.query?methods.highlightString(item.query,query):"",$item=$("<li>"+text+"</li>");return $item.on("click",(function(){var $this=$(this);$boasearchSuggestions.customReset(),$boasearch.val($this.text())})),$item},highlightString:function(str,query){var n=str.toLowerCase().indexOf(query.toLowerCase());if(n>=0){var before=str.substr(0,n),word=str.substr(n,query.length),after=str.substr(n+query.length);str=before+"<em>"+word+"</em>"+after}return str},nextItemMarkup:function(){var newposition,$current=$boasearchSuggestions.find(".current");newposition=($current.length<1?-1:$current.index())+1,$boasearchSuggestions.find("> li").length<=newposition&&(newposition=0),$current.removeClass("current");var $new=$boasearchSuggestions.children().eq(newposition);$new.addClass("current"),$boasearch.val($new.text())},previousItemMarkup:function(){var newposition,$current=$boasearchSuggestions.find(".current");(newposition=($current.length<1?-1:$current.index())-1)<0&&(newposition=$boasearchSuggestions.find("> li").length-1),$current.removeClass("current");var $new=$boasearchSuggestions.children().eq(newposition);$new.addClass("current"),$boasearch.val($new.text())},printItemsMarkup:function(title,data,query){data.length>0&&($.each(data,(function(k,item){var $item=methods.getItemMarkup(item,query,k);$boasearchSuggestions.append($item)})),$boasearchSuggestions.show(),$boasearchSuggestions.data("off",!1))},initSearch:function(){"function"==typeof $boasearch.conf.events.onstart?$boasearch.conf.events.onstart(startRecord>0):$boasearch.conf.results.target&&($($boasearch.conf.results.target).addClass("loading"),0===startRecord&&$($boasearch.conf.results.target).empty())},printResultSearch:function(data){if("function"==typeof $boasearch.conf.events.onfound)$boasearch.conf.events.onfound(data,startRecord);else if($boasearch.conf.results.target){var $target=$($boasearch.conf.results.target);$target.removeClass("loading"),$.each(data,(function(k,item){var $html=$('<div class="boa-video"></div>'),preview=BoAUtil.choosePreview(item);$html.append('<a href="'+item.about+'"><h5>'+item.metadata.general.title.none+"</h5></a>"),$html.append('<a href="'+item.about+'"><img src="'+preview+'.img" /></a>'),$html.append("<p>"+item.metadata.general.description.none+"</p>"),$target.append($html)}))}}};$boasearch.printSuggestions=function(query){for(var request in requestObjects)request&&"object"==typeof request&&request.abort();$boasearchSuggestions.customReset(),requestObjects=[];var uri=$boasearch.conf.apiuri;uri=uri.substr(0,uri.indexOf("/resources")),uri+="/queries.json";var params={q:query,"(n)":$boasearch.conf.options.suggestionsSize};if($boasearch.conf.filters.length>0){var filters=$boasearch.conf.filters.join(" AND ");params.filter=filters}requestObjects[requestObjects.length]=$.get(uri,params,(function(data){data.length>0&&(data.sort((function(a,b){return b.size-a.size})),methods.printItemsMarkup("",data,query))}))},$boasearch.search=function(){var currentTime=Date.now(),query=$boasearch.val();if(query.length<$boasearch.conf.options.minLetters)return!1;if(methods.initSearch(),cacheResults[query]&&cacheResults[query].timeQuery>currentTime-$boasearch.conf.options.cacheLife)return methods.printResultSearch(cacheResults[query].data),!0;cacheResults[query]={timeQuery:currentTime,data:[]};var params={q:query,"(n)":$boasearch.conf.options.resultsSize,"(s)":startRecord};return $boasearch.conf.filters.length>0&&$.each($boasearch.conf.filters,(function(k,filter){"object"==typeof filter.value?$.each(filter.value,(function(m,val){params["(meta)["+filter.meta+"]["+m+"]"]=val})):params["(meta)["+filter.meta+"]"]=filter.value})),$.ajax({url:$boasearch.conf.apiuri,data:params,dataType:"json",success:function(data){$boasearchSuggestions.empty(),"object"==typeof data&&data.error&&($boasearch.conf.events.onerror(data),data=[]),data.length>0&&(data.sort((function(a,b){return b.size-a.size})),cacheResults[query].data=data),methods.printResultSearch(data)},error:function(xhr){var data=xhr.responseText;$boasearch.conf.events.onerror($.parseJSON(data))},fail:function(xhr){var data=xhr.responseText;$boasearch.conf.events.onerror($.parseJSON(data))}}),!0},$boasearch.searchMore=function(){startRecord+=$boasearch.conf.options.resultsSize,$boasearch.search()},$boasearch.restart=function(){startRecord=0},methods.init()},$.boasearch.defaults={apiuri:null,catalogues:[],filters:[],options:{suggestionsSize:10,resultsSize:10,minLetters:3,cacheLife:6e4},debug:!1,results:{target:null,template:null},events:{onstart:null,onfound:null,onerror:function(error){return Log.debug("BoASearch - search error"),Log.debug(error),!0}}},$.fn.boasearch=function(params,paramval){if(void 0===params&&(params={}),"object"==typeof params)return this.each((function(){new $.boasearch(this,params)}));var $boasearch=null;if("data"in this?$boasearch=this.data("boasearch"):"data"in $(this)&&($boasearch=$(this).data("boasearch")),$boasearch)switch(params){case"search":$boasearch.search();break;case"nextsearch":$boasearch.searchMore();break;case"option":return $boasearch.conf.options[paramval];case"restart":$boasearch.restart();break;case"choosePreview":return BoAUtil.choosePreview(paramval)}else Log.debug("Error in boasearch object");return!0};var binditem=function($item){$item.find("[boa-href]").on("click",(function(){var $this=$(this),modalresource=$this.data("modal");if(modalresource)modalresource.show();else{var request=$.get($this.attr("boa-href")).then((function(data){data.custom={},data.custom.preview=BoAUtil.chooseView(data),data.custom.type=data.metadata.technical&&data.metadata.technical.format?data.metadata.technical.format:"",data.custom.score="avg"in data.social.score?data.social.score.avg+" / "+data.social.score.count:0,data.custom.downloadable=BoAUtil.isDownloadable(data),data.about=encodeURI(data.about);var socialnetworksitems=[];return $.each(global.socialnetworks,(function(i,v){var url=v.url.replace("{url}",encodeURI(data.about+"/!/"));url=url.replace("{name}",data.metadata.general.title.none);var item={};item.url=url,item.icon=v.icon,socialnetworksitems.push(item)})),data.custom.socialnetworks=socialnetworksitems,"object"==typeof data.metadata.general.keywords.none&&(data.metadata.general.keywords.none=data.metadata.general.keywords.none.join(", ")),Templates.render("mod_boa/viewresource",data)})).then((function(html){var $html=$(html);return $html.find("[data-addtoselection]").on("click",(function(){var $thisobject=$(this);global.selected[$thisobject.data("addtoselection")]?(global.selected[$thisobject.data("addtoselection")].detach(),delete global.selected[$thisobject.data("addtoselection")]):(global.selected[$thisobject.data("addtoselection")]=$item,$thisobject.removeClass("btn-primary").addClass("btn-danger"),$thisobject.find("span").html(s.removeselected),refreshadded()),$this.data("modal").hide()})),$html})).catch((function(error){Log.debug(error)}));ModalFactory.create({body:request.promise()}).then((function(modal){if(modalresource=modal,$item.data("metadata")){let itemdata=$item.data("metadata");modalresource.setTitle(itemdata.metadata.general.title.none)}return modal.getModal().addClass("block_boasearch-modal"),modal.show(),modal.getRoot().on(ModalEvents.hidden,(function(){$(modal.getBody()).find("video").each((function(){this.pause()})),$(modal.getBody()).find("audio").each((function(){this.pause()})),$(modal.getBody()).find("iframe").each((function(){$(this).attr("src","about:blank"),$this.data("modal",null)}))})),$this.data("modal",modalresource),!0})).catch((function(error){Log.debug(error)}))}}))},refreshadded=function(){let change=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var $container=$("#boa-currentselection > div.boa-items");if($container.children().detach(),$("#boa-currentselection > .alert").detach(),change&&$("#boa-currentselection .boa-saveselection").show(),global.selected)for(var about in global.selected){let $item=global.selected[about];$item?$container.append($item):$.get(about).then((function(data){data.thumb=BoAUtil.choosePreview(data);var $item=$(BoAUtil.itemContent(data));return binditem($item),$item.data("metadata",data),global.selected[data.about]=$item,$container.append($item),!0})).fail((function(e){Log.debug("Error loading resource"),Log.debug(e)}))}};return{init:function(blockid,cmid,boauri,pagesize,socialnetworks){pagesize=pagesize||10,global.socialnetworks=socialnetworks,$.each(M.boacurrentselection,(function(index,uri){global.selected[uri]=null})),s=BoAUtil.loadStrings(strings),$("#"+blockid).each((function(){var $thisblock=$(this),$searchResult=$thisblock.find('[data-control="search-result"]'),$boaSearch=$thisblock.find('[data-control="search-text"]');$errorBox=$thisblock.find('[data-control="errors-box"]'),$thisblock.find('[data-control="search-button"]').on("click",(function(){$thisblock.find("> .search-result").empty(),$boaSearch.boasearch("restart"),$boaSearch.boasearch("search")})),$boaSearch.boasearch({apiuri:boauri[0],catalogues:[],filters:[],options:{cacheLife:2e3,resultsSize:pagesize},events:{onstart:function(more){$searchResult.addClass("loading"),$searchResult.show(),more||$searchResult.find("> .boa-content").empty()},onfound:function(data,start){$searchResult.removeClass("loading");var $target=$searchResult.find("> .boa-content"),resultsSize=$boaSearch.boasearch("option","resultsSize");if(0===data.length||data.length<resultsSize?$searchResult.find("> button").hide():$searchResult.find("> button").show(),0==start&&$thisblock.find('[data-control="show-one"]').empty(),data&&0!==data.length||0!=start)$.each(data,(function(k,item){if(!global.selected[item.about]){"external"==item.manifest.conexion_type?item.finaluri=item.manifest.url:(item.finaluri=item.about+"/!/",item.manifest.entrypoint&&(item.finaluri+=item.manifest.entrypoint)),item.thumb=BoAUtil.choosePreview(item);var $item=$(BoAUtil.itemContent(item));$item.data("metadata",item),$item.appendTo($target),binditem($item)}}));else{$target.empty();var content=BoAUtil.showMessage(s.noresultsfound);$target.append(content)}},onerror:function(error){var $target=$errorBox;$target.empty();var $node=BoAUtil.showMessage(error.message,"error",error.info);$target.append($node),Log.debug(error),$target.removeClass("loading")}}}),$searchResult.find("> button").on("click",(function(){$boaSearch.boasearch("nextsearch")}))}));var $saveselection=$("#boa-currentselection .boa-saveselection");$saveselection.hide(),$saveselection.on("click",(function(){var $thisbutton=$(this),data=[];for(var about in global.selected)data.push(about);Ajax.call([{methodname:"mod_boa_select_resources",args:{cmid:cmid,list:data}}])[0].then((function(data){if(data){let $msg=BoAUtil.showMessage(s.saved,"success");$saveselection.after($msg)}else{let $msg=BoAUtil.showMessage(s.notsaved);$saveselection.after($msg)}return $thisbutton.hide(),!0})).fail((function(e){Log.debug("Error saving resources selected"),Log.debug(e)}))})),refreshadded(!1)}}}));

//# sourceMappingURL=main.min.js.map