{"version":3,"file":"util.min.js","sources":["../src/util.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Useful features for the OVA management process.\n *\n * @module     mod_boa/util\n * @copyright  2024 David Herney @ BambuCo\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport {get_strings as getStrings} from 'core/str';\nimport Log from 'core/log';\n\n/* eslint complexity: [\"error\", 30] */\nexport const chooseView = (data) => {\n\n    var $res = null;\n\n    // If it is a external resource.\n    if (data.manifest.conexion_type && data.manifest.conexion_type == 'external') {\n        $res = $('<iframe></iframe>');\n        $res.attr('src', data.manifest.url);\n\n        var $reslink = $('<p><a target=\"_blank\"></a></p>');\n        $reslink.find('a').attr('href', data.manifest.url).html(data.manifest.url);\n\n        return $res.get(0).outerHTML + $reslink.get(0).outerHTML;\n    }\n\n    if (!data.metadata.technical || !data.metadata.technical.format) {\n        return $res;\n    }\n\n    if (data.metadata.technical.format.match(/pdf/gi) ||\n            data.metadata.technical.format.match(/html/gi) ||\n            data.metadata.technical.format.match(/tepuy/gi)) {\n        var proxyuri = 'proxy/index.php/' + window.btoa(data.about + '/!/') + '/';\n\n        // The id scorm_object is a hack to play Tepuy objects.\n        $res = $('<iframe id=\"scorm_object\"></iframe>');\n        $res.attr('src', proxyuri);\n        $res.attr('type', data.metadata.technical.format);\n\n        return $res;\n    }\n\n    var src = '';\n    var alternatebase;\n    if (data.id.indexOf('/content/') >= 0) {\n        alternatebase = data.id.substr(data.id.indexOf('/content/') + 9);\n    } else {\n        alternatebase = data.manifest.entrypoint;\n    }\n\n    if (data.manifest.alternate && data.manifest.entrypoint) {\n        var alterpath = data.about + '/!/.alternate/' + alternatebase + '/';\n        var name = '';\n\n        if (data.metadata.technical.format.match(/video/gi) ||\n                data.metadata.technical.format.match(/audio/gi) ||\n                data.metadata.technical.format.match(/image/gi)) {\n\n            if (typeof data.manifest.alternate == 'object') {\n                name = data.manifest.alternate.find(e => /small/g.test(e));\n\n                if (name) {\n                    src = alterpath + name;\n                } else {\n                    name = data.manifest.alternate.find(e => /medium/g.test(e));\n                    src = name ? alterpath + name : data.about + '/!/' + data.manifest.entrypoint;\n                }\n            } else {\n                src = data.about + '/!/' + data.manifest.entrypoint;\n            }\n        } else {\n            name = typeof data.manifest.alternate == 'object' ?\n                            data.manifest.alternate.find(e => /thumb/g.test(e)) : '';\n            src = name ? alterpath + name : data.manifest.customicon;\n        }\n\n    } else {\n        if ('technical' in data.metadata && 'format' in data.metadata.technical &&\n                (data.metadata.technical.format.match(/video/gi) ||\n                data.metadata.technical.format.match(/audio/gi) ||\n                data.metadata.technical.format.match(/image/gi))) {\n            src = data.about + '/!/';\n        } else {\n            src = data.manifest.customicon;\n        }\n    }\n\n    if (data.metadata.technical.format.match(/video/gi)) {\n        $res = $('<video controls><source></source></video>');\n        $res.find('source').attr('src', src).attr('type', data.metadata.technical.format);\n\n    } else if (data.metadata.technical.format.match(/audio/gi)) {\n        $res = $('<audio controls><source></source></audio>');\n        $res.find('source').attr('src', src).attr('type', data.metadata.technical.format);\n\n    } else {\n        $res = $('<img />');\n        $res.attr('src', src).attr('alt', data.metadata.general.title.none);\n    }\n\n    return $res.get(0).outerHTML;\n};\n\n/**\n * Return the OVA item HTML.\n *\n * @param {object} item The OVA item metadata.\n * @param {string} tpl The HTML base template.\n * @returns {string} The item HTML content.\n */\nexport const itemContent = (item, tpl = null) => {\n\n    if (!tpl) {\n        var $boatpl = $('#boa-tpl-item');\n        if ($boatpl.length > 0) {\n            tpl = $boatpl[0].innerHTML;\n        } else {\n            // Default simple template.\n            tpl = [\n                '<div class=\"boa-item\">',\n                '<div class=\"boa-thumb\">',\n                '<img src=\"{thumb}\" alt=\"{title}\" />',\n                '</div>',\n                '<div class=\"boa-content\">',\n                '<h3>{title}</h3>',\n                '<p>{description}</p>',\n                '<div class=\"boa-social\">',\n                '<span class=\"boa-comments\">{comments}</span>',\n                '<span class=\"boa-score\">{score}</span>',\n                '<span class=\"boa-views\">{views}</span>',\n                '</div>',\n                '</div>',\n                '</div>'\n            ].join('');\n        }\n    }\n\n    var content = tpl;\n    var type = (item.metadata.technical && item.metadata.technical.format) ? item.metadata.technical.format : '';\n\n    content = content.replace(/{thumb}/g, item.thumb);\n    content = content.replace(/{title}/g, item.metadata.general.title.none);\n    content = content.replace(/{about}/g, item.about);\n    content = content.replace(/{description}/g, item.metadata.general.description.none);\n    content = content.replace(/{comments}/g, item.social.comments);\n    content = content.replace(/{score}/g, item.social.score.count ? item.social.score.sum + '/' + item.social.score.count : 0);\n    content = content.replace(/{views}/g, item.social.views);\n    content = content.replace(/{type}/g, type);\n\n    return content;\n};\n\n/**\n * Define the OVA item preview image.\n *\n * @param {object} item\n * @returns\n */\nexport const choosePreview = (item) => {\n\n    if ('alternate' in item.manifest && item.manifest.entrypoint) {\n\n        var alternatebase;\n\n        if (item.id.indexOf('/content/') >= 0) {\n            alternatebase = item.id.substr(item.id.indexOf('/content/') + 9);\n        } else {\n            alternatebase = item.manifest.entrypoint;\n        }\n\n        var alterpath = item.about + '/!/.alternate/' + alternatebase;\n\n        if (item.manifest.alternate.indexOf('preview.png') >= 0) {\n            return alterpath + '/preview.png';\n        } else if (item.manifest.alternate.indexOf('thumb.png') >= 0) {\n            return alterpath + '/thumb.png';\n        }\n    }\n\n    return item.about + '.img?s=128';\n};\n\n/**\n * Check if the OVA item is downloadable.\n *\n * @param {object} data The OVA item metadata.\n * @returns {boolean} True if the item is downloadable, false otherwise.\n */\nexport const isDownloadable = (data) => {\n    // ToDo: validate by content type.\n    return !data.manifest.conexion_type || data.manifest.conexion_type != 'external';\n};\n\n/**\n * Load strings from server.\n *\n * @param {array} strings The strings to load.\n *\n */\nexport const loadStrings = (strings) => {\n\n    var s = {};\n\n    strings.forEach(one => {\n        s[one.key] = one.key;\n    });\n\n    getStrings(strings).then(function(results) {\n        var pos = 0;\n        strings.forEach(one => {\n            s[one.key] = results[pos];\n            pos++;\n        });\n\n        return true;\n    }).fail(function(e) {\n        Log.debug('Error loading strings');\n        Log.debug(e);\n    });\n\n    return s;\n};\n\nexport const showMessage = (text, type, info, $errorBox) => {\n    type = type ? type : 'error';\n    info = info ? info : '';\n\n    if (type == 'error') {\n        type = 'danger';\n    }\n\n    var content = [\n        '<div class=\"alert alert-dismissible alert-' + type + '\">',\n        '<button type=\"button\" class=\"close\" data-dismiss=\"alert\">&times;</button>',\n        '<p>' + text + '</p>',\n        '<div>' + info + '</div>',\n        '</div>'\n    ].join('');\n\n    var $content = $(content);\n\n    $content.find('button.close').on('click', function() {\n        $content.remove();\n    });\n\n    if ($errorBox) {\n        $errorBox.find('> .alert').remove();\n        $errorBox.append($content);\n        return true;\n    }\n\n    return $content;\n\n};\n"],"names":["data","$res","manifest","conexion_type","attr","url","$reslink","find","html","get","outerHTML","metadata","technical","format","match","proxyuri","window","btoa","about","alternatebase","src","id","indexOf","substr","entrypoint","alternate","alterpath","name","e","test","customicon","general","title","none","item","tpl","$boatpl","length","innerHTML","join","content","type","replace","thumb","description","social","comments","score","count","sum","views","strings","s","forEach","one","key","then","results","pos","fail","debug","text","info","$errorBox","$content","on","remove","append"],"mappings":"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"}